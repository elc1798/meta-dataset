import numpy as np
import matplotlib.pyplot as plt
plt.rcParams.update({'font.size': 22})
from scipy.special import softmax

dataset_names = 'ilsvrc_2012,aircraft,cu_birds,omniglot,quickdraw,vgg_flower,dtd,fungi,traffic_sign,mscoco,mnist,cifar10,cifar100'.split(',')
dataset_to_idx = {v: i for i, v in enumerate(dataset_names)}

ddc_logits = {
    "dse-small": {
        "ilsvrc_2012": np.array([9.052833, -0.526497  , -0.95852125, -2.519905, -1.433126, -1.4214182 , -0.21614715, -1.1776332]),
        "aircraft": np.array([-1.243821, 6.9561653, 0.1835332, -0.5884343, -1.1925904, -0.3716803, -0.866805, -2.076138]),
        "cu_birds": np.array([0.4149542, -0.2752001,  7.6226935, -0.98107535, -1.7154849, -1.193115, -1.2523926, -1.8211737]),
        "omniglot": np.array([-2.6341648, -0.16921403, -0.01486769, 6.9056478,  0.16092028, -0.76542914, -1.1045212, -1.5774375]),
        "quickdraw": np.array([-1.1057014 , -0.96994525, -1.4119799, 0.23411535, 7.116263, -1.0648689 , -0.74601305, -1.2519847 ]),
        "vgg_flower": np.array([-1.8945612 , -0.46132618, -0.95046866, -1.0376027 , -1.4353592, 7.1766334 , -0.80475116,  0.20656906]),
        "dtd": np.array([-0.27968067, -1.0573353, -1.2235489, -1.8194969, -1.2467537, -0.93950844, 7.559522, -0.19356677]),
        "fungi": np.array([ 0.07051329, -1.9703571 , -1.4491695 , -1.7708075 , -1.6314522 , 0.35246372, -0.10892674,  7.3066754 ]),
        "traffic_sign": np.array([ 2.5757449, -1.6345857, -1.5310487, -1.7169949,  0.2764536, 0.8364362,  1.6236672,  0.3699698]),
        "mscoco": np.array([ 7.2660675 , -1.3828757 , -1.1736423 , -2.4114492 , -1.1842376 , -0.6192571 ,  0.94142336, -0.6364931 ]),
        "mnist": np.array([-1.1105026 , -0.9898011 , -1.4410751 ,  0.38711852,  6.988827  , -1.0555387 , -0.74357545, -1.2355237 ]),
        "cifar10": np.array([ 3.165198  , -1.704913  , -1.6965114 , -2.1824493 , -0.99743396, 1.6525235 ,  0.60773313,  1.9553131 ]),
        "cifar100": np.array([ 2.7770445, -1.8020935, -1.7282017, -2.155011 , -1.0201173, 1.8570756,  1.199685 ,  1.6710883]),
    },
    "dse-small-0shot": {
        "ilsvrc_2012": np.array([ 9.067651  , -0.52905375, -0.96577716, -2.523851  , -1.4320455 , -1.4174865 , -0.21042523, -1.1894294 ]),
        "aircraft": np.array([-1.2549725 ,  6.954978  ,  0.190328  , -0.5861857 , -1.1936902 , -0.37075925, -0.8676641 , -2.0718126 ]),
        "cu_birds": np.array([ 0.426963  , -0.27308038,  7.6238    , -0.98401827, -1.7167822 , -1.2156272 , -1.2530742 , -1.8089833 ]),
        "omniglot": np.array([-2.6344001 , -0.16864347, -0.01464714,  6.9067717 ,  0.16019703,-0.76594704, -1.1056744 , -1.5767263 ]),
        "quickdraw": np.array([-1.1050808 , -0.9698046 , -1.4119066 ,  0.23387827,  7.113689  , -1.0644902 , -0.7447937 , -1.2516055 ]),
        "vgg_flower": np.array([-1.8427165 , -0.44979   , -0.9533939 , -1.0539331 , -1.4383881 , 7.158326  , -0.8169633 ,  0.19599187]),
        "dtd": np.array([-0.24138568, -1.0511379 , -1.2500592 , -1.8096185 , -1.241255  , -0.98036945,  7.548935  , -0.17548047]),
        "fungi": np.array([ 0.12163126, -1.9848368 , -1.4091003 , -1.7739768 , -1.6372049 , 0.35911402, -0.11186971,  7.235181  ]),
        "traffic_sign": np.array([ 2.9435835 , -1.6836097 , -1.4751296 , -1.7870612 ,  0.1720548 , 0.77462614,  1.5685021 ,  0.2866692 ]),
        "mscoco": np.array([ 7.386926  , -1.3891845 , -1.1622254 , -2.4524143 , -1.2026885 , -0.5736052 ,  0.89813346, -0.7054224 ]),
        "mnist": np.array([-1.1097348 , -0.98899484, -1.4402559 ,  0.37505138,  7.0028124 , -1.055996  , -0.74564797, -1.2373054 ]),
        "cifar10": np.array([ 3.1248655, -1.6969864, -1.7121875, -2.1754448, -0.9985972, 1.6811236,  0.603015 ,  1.9736688]),
        "cifar100": np.array([ 2.7342434, -1.7982005, -1.7242616, -2.1469383, -1.0222509, 1.8803285,  1.1897355,  1.6868103]),
    },
}

# Get heatmap

def get_heatmap(experiment):
    # 1. Apply softmax to get probabilities
    probs = np.zeros((8 + 5, 8))
    for dataset, raw in ddc_logits[experiment].items():
        probs[dataset_to_idx[dataset]] = softmax(raw)
    probs = np.transpose(probs)

    # 2. Heatmap
    fig, axis = plt.subplots()
    heatmap = axis .pcolor(probs, cmap='YlGnBu')
    axis.set_yticks(np.arange(probs.shape[0]) + 0.5, minor=False)
    axis.set_xticks(np.arange(probs.shape[1]) + 0.5, minor=False)
    axis.invert_yaxis()
    axis.set_yticklabels(dataset_names[:8], minor=False)
    axis.set_xticklabels(dataset_names, minor=False)
    plt.xticks(rotation=90)
    plt.colorbar(heatmap)
    fig.set_size_inches(13 + 3, 8)
    plt.tight_layout()
    plt.show()

get_heatmap('dse-small-0shot')
